---
title: "chrom17m"
author: "Kellie Ottoboni"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Vignette Info

This example comes from Chapter 6, page 305-307.

We'll consider an application concerning a case/control study in which the dependent variable is the haplotypical expression in a chromosome 17 marker. The goal of the study is to estimating the association between the group variable (Cases/Controls) and the marker (the categorical variable).
```{r}
library(permuter)
data(chrom17m)
chrom17m


 


```
The association test was performed using $\chi^2$ (asymptotic and exact) and $T_{SM}$ tests (Sham and Curtis, 1995). Moreover, the analysis was developed following the multifocus approach. Ten thousand CMC iterations were carried out for the four tests based on a permutation strategy.


```{r firstanalysis}
B <- 1000

###NEW
X1 <- rep(chrom17m$Groups, chrom17m$Cases)
X2 <- rep(chrom17m$Groups, chrom17m$Controls)
X <- as.factor(c(X1, X2))
k <- nrow(chrom17m)
n1 <- sum(chrom17m$Cases)
n2 <- sum(chrom17m$Controls)
n <- n1 + n2
l <- rep(c(1, 2), c(n1, n2))
data <- chrom17m[, -1]
marginal <- rowSums(chrom17m[,-1])

observed <- rep(0, k)
distr <- matrix(0, nrow = B, ncol = k)
for(kk in 1:k){
  observed[kk] <- (chrom17m[kk, 2] - marginal[kk] * n1/n)^2/(marginal[kk] * n1/n)
  for(bb in 1:B){
    X.star <- sample(X)
    data.star <- table(X.star, l)
    marginal.star <- rowSums(data.star)
    distr[bb, kk] <- (data.star[kk, 1] - marginal.star[kk] * n1/n)^2/(marginal.star[kk] * n1/n)
  }
}

partial_pvalues <- sapply(1:k, function(i) t2p(observed[i], distr[,i], alternative="greater"))
names(partial_pvalues) <- chrom17m$Groups
partial_pvalues

adjusted_pvalues <- fwe_minp(partial_pvalues, distr)
names(adjusted_pvalues) <- chrom17m$Groups
adjusted_pvalues


###OLD
G <- chrom17m[, 1]
f1 <- chrom17m[, 2]
f2 <- chrom17m[, 3]
X1 <- rep(G, f1)
X2 <- rep(G, f2)
K <- dim(chrom17m)[1]
n1 <- sum(f1)
n2 <- sum(f2)
n <- n1 + n2

L <- rep(c(1, 2), c(n1, n2))
X <- c(X1, X2)  ## note: the factors are automatically recoded as integer

data <- chrom17m[, -1]

T <- array(0, dim = c((B + 1), K))


for (i in 1:K) {
    T[1, i] <- (data[i, 1] - (sum(data[i, ])) * n1/n)^2/((sum(data[i, ])) * n1/n)
}


for (bb in 2:(B + 1)) {
    
    X.star <- sample(X)
    data.star <- table(X.star, L)
    
    for (i in 1:K) {
        T[bb, i] <- (data.star[i, 1] - (sum(data.star[i, ])) * n1/n)^2/((sum(data.star[i, 
            ])) * n1/n)
    }
    
}


P <- t2p_old(T)
p.part <- t2p_old(T)[1, ]
names(p.part) <- G
p.part

FWE.p <- t(FWE.minP_old(P))
colnames(FWE.p) <- G
FWE.p



 


```

## Globals
```{r globals}
T.Tipp <- apply(P, 1, min)
T.Fish <- apply(P, 1, function(x) {
    -2 * log(prod(x))
})
T.Lipt <- apply(P, 1, function(x) {
    sum(qnorm(1 - x))
})

p.glob.Tipp <- mean(T.Tipp[-1] <= T.Tipp[1])
p.glob.Fish <- mean(T.Fish[-1] >= T.Fish[1])
p.glob.Lipt <- mean(T.Lipt[-1] >= T.Lipt[1])



 


```